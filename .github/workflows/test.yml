name: Test Rust Application

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Install Dependencies
        run: sudo apt-get install -y wget ffmpeg

      - name: Create Downloads Directory
        run: |
          mkdir -p ./Downloads
          echo "Created Downloads directory at $(pwd)/Downloads"

      - name: Build Application (downloadManager)
        run: |
          cargo build --release --bin downloadManager
          echo "Application (downloadManager) built successfully."

      - name: Run Application in Background
        run: |
          target/release/downloadManager > app.log 2>&1 &
          echo "Application started in background."

      - name: Download Test Files
        run: |
          wget -P ./Downloads https://via.placeholder.com/150 -O ./Downloads/test_image.jpg
          echo "Generating test video file..."
          ffmpeg -f lavfi -i testsrc=duration=10:size=1280x720:rate=30 ./Downloads/test_video.mp4
          echo "Test files downloaded and generated."

      - name: Verify Files Moved
        run: |
          if [ ! -f ./Downloads/Images/test_image.jpg ]; then
            echo "Test image was not moved to Images directory!" && exit 1
          fi
          if [ ! -f ./Downloads/Videos/test_video.mp4 ]; then
            echo "Test video was not moved to Videos directory!" && exit 1
          fi
          echo "Files moved successfully!"

      - name: Stop Background Application
        run: |
          pkill -f 'target/release/downloadManager'
          echo "Background application stopped."

      - name: Verify Weekly Report Generation
        run: |
          if [ ! -f ./Downloads/Weekly_Report.html ]; then
            echo "Weekly report was not generated!" && exit 1
          fi
          echo "Weekly report generated successfully!"

      - name: Display Application Logs
        run: |
          echo "Displaying application logs:" && cat app.log
